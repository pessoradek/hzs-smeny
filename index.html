<script>
const sb_url = 'https://gawleyyyvfaqdfuxwdco.supabase.co';
const sb_key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdhd2xleXl5dmZhcWRmdXh3ZGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMDE4MjIsImV4cCI6MjA4NDU3NzgyMn0.0ApUn-Mbz6L7hyotwrevr_1OCz42-EbqHAFkQUUYQ4o';
const _db = supabase.createClient(sb_url, sb_key);

const ALL_COURSES = ['V','S','Z','KBJ','P','LI','D','L','CH','ZPP','OD'];
const VEHICLES = [
    {name:'První výjezd (Scania)',roles:['S','V','any','any']},
    {name:'Druhý výjezd (MAN)',roles:['V','S','any','any','any','any']},
    {name:'CAS 30 (PSA 102)',roles:['any','any']},
    {name:'AZ 30 (Scania)',roles:['any','any']},
    {name:'RZA (VW)',roles:['any','any']},
    {name:'VPP (Kodiaq)',roles:['any','any']},
    {name:'Sanita (Crafter)',roles:['any','any']},
    {name:'KOPIS',roles:['OD','OD']},
    {name:'Ostatní technika',roles:['any','any']}
];

const RANKS = ['plk.','pplk.','mjr.','kpt.','por.','npor.','ppor.','nprap.','prap.','pprap.','nstržm.','stržm.','rtn.'];

let members = [];

function init(){
    // naplníme hodnosti do registrace
    document.getElementById('reg-rank').innerHTML = RANKS.map(r=>`<option value="${r}">${r}</option>`).join('');
    
    // kurzy
    document.getElementById('reg-courses').innerHTML = ALL_COURSES.map(c=>`<label><input type="checkbox" value="${c}">${c}</label>`).join('');
    
    // vozidla a role
    const vehContainer = document.getElementById('vehicles-container');
    vehContainer.innerHTML = VEHICLES.map(v=>`
        <div class="vehicle-card">
            <h3>${v.name}</h3>
            ${v.roles.map(r => `<div class="form-row"><label>${r==='any'?'Hasič':r==='OD'?'Operační důstojník':r==='S'?'Strojník':'Velitel'}:</label><select data-role="${r}"></select></div>`).join('')}
        </div>
    `).join('');
    
    loadData();
}

async function loadData(){
    const { data, error } = await _db.from('members').select('*');
    if(error) return alert("Chyba načtení: "+error.message);
    members = data || [];
    renderTable();
    renderSelects();
}

function renderTable(){
    const tbody = document.querySelector('#members-table tbody');
    tbody.innerHTML = members.map(m=>`
        <tr>
            <td>${m.rank}</td>
            <td>${m.first_name} ${m.last_name}</td>
            <td>${(m.courses||[]).map(c=>`<span class="course-tag">${c}</span>`).join('')}</td>
            <td>${m.shift_count||0}</td>
            <td>
                <button class="small-btn" onclick="openEdit('${m.id}')">✏️</button>
                <button class="small-btn" onclick="deleteMember('${m.id}')">❌</button>
            </td>
        </tr>
    `).join('');
}

function renderSelects(){
    document.querySelectorAll('select[data-role]').forEach(sel=>{
        const role = sel.dataset.role;
        let h = '<option value="">-- vybrat --</option>';
        members.forEach(m=>{
            if(role==='any' || (m.courses && m.courses.includes(role))){
                h += `<option value="${m.id}">${m.rank} ${m.last_name}</option>`;
            }
        });
        sel.innerHTML = h;
    });
}

async function registerMember(){
    const fn = document.getElementById('reg-fname').value.trim();
    const ln = document.getElementById('reg-lname').value.trim();
    const crs = Array.from(document.querySelectorAll('#reg-courses input:checked')).map(c=>c.value);
    if(!fn||!ln) return alert("Chybí jméno!");
    const { error } = await _db.from('members').insert({ first_name: fn, last_name: ln, rank: document.getElementById('reg-rank').value, courses: crs, shift_count: 0 });
    if(error) return alert("Chyba: "+error.message);
    alert("Člen úspěšně registrován!");
    document.getElementById('reg-fname').value='';
    document.getElementById('reg-lname').value='';
    document.querySelectorAll('#reg-courses input').forEach(i=>i.checked=false);
    loadData();
}

async function submitShift(){
    // uloží jen vybrané selecty
    const ids = [...new Set(Array.from(document.querySelectorAll('select')).map(s=>s.value).filter(v=>v))];
    if(!ids.length) return alert("Nikdo není vybrán!");
    const date = new Date().toLocaleDateString('cs-CZ');
    for(let id of ids){
        const m = members.find(x=>String(x.id)===String(id));
        await _db.from('members').update({ shift_count:(m.shift_count||0)+1, last_shift:date }).eq('id',id);
    }
    alert("Směna zapsána!");
    loadData();
}

function switchTab(e,id){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    e.currentTarget.classList.add('active');
}

function openEdit(id){
    const m = members.find(x=>String(x.id)===String(id));
    if(!m) return;
    document.getElementById('edit-id').value = m.id;
    document.getElementById('edit-name').innerText = `Upravit ${m.first_name} ${m.last_name}`;
    document.getElementById('edit-count').value = m.shift_count || 0;
    
    const rankSelect = document.getElementById('edit-rank');
    rankSelect.innerHTML = RANKS.map(r=>`<option value="${r}">${r}</option>`).join('');
    rankSelect.value = m.rank;
    
    const div = document.getElementById('edit-courses-div');
    div.innerHTML = ALL_COURSES.map(c=>`<label><input type="checkbox" value="${c}" ${m.courses&&m.courses.includes(c)?'checked':''}>${c}</label>`).join('');
    
    document.getElementById('edit-modal').style.display='flex';
}

async function saveEdit(){
    const id = document.getElementById('edit-id').value;
    const rank = document.getElementById('edit-rank').value;
    const count = parseInt(document.getElementById('edit-count').value)||0;
    const courses = Array.from(document.querySelectorAll('#edit-courses-div input:checked')).map(i=>i.value);
    const { error } = await _db.from('members').update({ rank, shift_count:count, courses }).eq('id',id);
    if(error) return alert("Chyba: "+error.message);
    closeEdit();
    loadData();
}

async function deleteMember(id){
    if(!confirm("Opravdu chceš smazat tohoto člena?")) return;
    const { error } = await _db.from('members').delete().eq('id', id);
    if(error) return alert("Chyba mazání: "+error.message);
    alert("Člen byl smazán!");
    loadData();
}

function closeEdit(){document.getElementById('edit-modal').style.display='none';}

document.getElementById('date-display').innerText = new Date().toLocaleDateString('cs-CZ');
init();
</script>
