<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HZS Smƒõnovnice</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg:#1a1a1a; --text:#e0e0e0; --accent:#e63946; --panel:#2d2d2d; --border:#444; --input-bg:#222; }
        body { font-family:'Segoe UI', sans-serif; background:var(--bg); color:var(--text); padding:20px; margin:0; }
        .container { max-width:1400px; margin:0 auto; }
        .tabs { display:flex; gap:5px; margin-bottom:20px; }
        .tab-btn { background:var(--panel); border:1px solid var(--border); color:white; padding:10px 20px; cursor:pointer; border-radius:4px; transition:0.2s; }
        .tab-btn:hover { background:#3d3d3d; }
        .tab-btn.active { background:var(--accent); font-weight:bold; }
        .section { display:none; background:var(--panel); padding:20px; border-radius:8px; border:1px solid var(--border); }
        .section.active { display:block; }
        .grid-layout { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:15px; }
        .vehicle-card { background:#333; border:1px solid var(--border); padding:15px; border-radius:5px; border-left:5px solid var(--accent); position:relative; }
        .vehicle-card h3 { margin:0 0 15px 0; color:var(--accent); font-size:1.1em; border-bottom:1px solid #444; padding-bottom:5px; }
        
        /* Formul√°≈ôe a inputy */
        .form-row { display:flex; align-items:center; margin-bottom:8px; position:relative; }
        .form-row label { width:110px; font-size:0.85em; font-weight:bold; flex-shrink:0; }
        select, input[type="text"], input[type="number"] { 
            flex:1; padding:8px; background:var(--input-bg); border:1px solid #555; color:white; border-radius:4px; 
            font-size:0.95em;
        }
        select:focus, input:focus { outline:1px solid var(--accent); border-color:var(--accent); }

        /* Tabulka */
        table { width:100%; border-collapse:collapse; margin-top:20px; }
        th,td { padding:12px; text-align:left; border-bottom:1px solid var(--border); }
        .course-tag { display:inline-block; background:#555; color:white; padding:2px 6px; border-radius:3px; font-size:0.75em; margin:2px; border:1px solid #666; }
        
        /* Tlaƒç√≠tka */
        .action-btn { background:var(--accent); color:white; border:none; padding:15px; cursor:pointer; border-radius:4px; width:100%; font-weight:bold; margin-top:20px; transition:0.2s; }
        .action-btn:hover { background:#c92a35; }
        .small-btn { background:#555; color:white; border:none; padding:6px 10px; margin:2px; border-radius:4px; cursor:pointer; font-size:0.85em; }
        .small-btn:hover { background:#666; }
        
        /* Kurzy grid */
        .course-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(50px,1fr)); gap:8px; margin:10px 0; background:var(--input-bg); padding:10px; border-radius:4px; }
        .course-grid label { font-size:0.8em; cursor:pointer; display:block; background:#333; padding:4px; text-align:center; border-radius:3px; border:1px solid #444; }
        .course-grid input { display:none; }
        .course-grid input:checked + span { color:var(--accent); font-weight:bold; }

        /* --- VYHLED√ÅVAC√ç SELECT (OPRAVEN√ù) --- */
        .searchable-wrapper { position: relative; flex:1; }
        .search-input { width: 100%; box-sizing: border-box; cursor: text; }
        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            background: #2a2a2a;
            border: 1px solid var(--accent);
            border-radius: 0 0 4px 4px;
            z-index: 9999; /* Vy≈°≈°√≠ z-index */
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.6);
        }
        .suggestions-list.show { display: block; }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #3d3d3d;
            font-size:0.9em;
            color: #ccc;
        }
        .suggestion-item:hover { background: var(--accent); color: white; }
        .suggestion-item .rank-badge { font-weight: bold; color: var(--accent); margin-right: 5px; }
        .suggestion-item:hover .rank-badge { color: white; }

        /* Modal */
        #edit-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center; }
        .modal-content { background:var(--panel); padding:25px; border-radius:8px; width:90%; max-width:450px; border:1px solid var(--accent); box-shadow:0 10px 25px rgba(0,0,0,0.5); }
        .modal-buttons { display:flex; gap:10px; margin-top:20px; }
    </style>
</head>
<body>
<div class="container">
    <h1>üë®‚Äçüöí HZS Smƒõnovnice</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(event,'rozkaz')">Denn√≠ rozkaz</button>
        <button class="tab-btn" onclick="switchTab(event,'registrace')">Registrace</button>
        <button class="tab-btn" onclick="switchTab(event,'databaze')">Datab√°ze</button>
    </div>

    <div id="rozkaz" class="section active">
        <h2 id="date-display"></h2>
        <form id="shiftForm">
            <div class="grid-layout" id="vehicles-container"></div>
            <button type="button" class="action-btn" onclick="submitShift()">üíæ ZAPSAT SMƒöNU</button>
        </form>
    </div>

    <div id="registrace" class="section">
        <h2>Nov√Ω ƒçlen</h2>
        <div class="form-row"><label>Jm√©no:</label><input type="text" id="reg-fname"></div>
        <div class="form-row"><label>P≈ô√≠jmen√≠:</label><input type="text" id="reg-lname"></div>
        <div class="form-row"><label>Hodnost:</label>
            <select id="reg-rank"></select>
        </div>
        <p>Kurzy:</p>
        <div class="course-grid" id="reg-courses"></div>
        <button class="action-btn" onclick="registerMember()">‚ûï Registrovat</button>
    </div>

    <div id="databaze" class="section">
        <h2>Seznam p≈ô√≠slu≈°n√≠k≈Ø</h2>
        <div style="overflow-x:auto;">
            <table id="members-table">
                <thead><tr><th>Hodnost</th><th>Jm√©no</th><th>Kurzy</th><th>Smƒõny</th><th>Posledn√≠ smƒõna</th><th>Akce</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="edit-modal">
    <div class="modal-content">
        <h3 id="edit-name">Upravit</h3>
        <input type="hidden" id="edit-id">
        <div class="form-row"><label>Hodnost:</label><select id="edit-rank"></select></div>
        <div class="form-row"><label>Smƒõny:</label><input type="number" id="edit-count"></div>
        <p>Kurzy:</p>
        <div class="course-grid" id="edit-courses-div"></div>
        <div class="modal-buttons">
            <button class="action-btn" onclick="saveEdit()">üíæ Ulo≈æit</button>
            <button class="action-btn" style="background:#555" onclick="closeEdit()">Zav≈ô√≠t</button>
        </div>
    </div>
</div>

<script>
const sb_url = 'https://gawleyyyvfaqdfuxwdco.supabase.co';
const sb_key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdhd2xleXl5dmZhcWRmdXh3ZGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMDE4MjIsImV4cCI6MjA4NDU3NzgyMn0.0ApUn-Mbz6L7hyotwrevr_1OCz42-EbqHAFkQUUYQ4o';
const _db = supabase.createClient(sb_url, sb_key);

const ALL_COURSES = ['V','S','Z','KBJ','P','LI','D','L','CH','ZPP','OD','SSP'];
const VEHICLES = [
    {name:'Prvn√≠ v√Ωjezd (Scania)',roles:['S','V','any','any']},
    {name:'Druh√Ω v√Ωjezd (MAN)',roles:['V','S','any','any','any','any']},
    {name:'CAS 30 (PSA 102)',roles:['any','any']},
    {name:'AZ 30 (Scania)',roles:['any','any']},
    {name:'RZA (VW)',roles:['any','any']},
    {name:'VPP (Kodiaq)',roles:['any','any']},
    {name:'Sanita (Crafter)',roles:['any','any']},
    {name:'KOPIS',roles:['OD','OD']},
    {name:'Ostatn√≠ technika',roles:['any','any']}
];

const RANKS = ['plk.','pplk.','mjr.','kpt.','npor.','por.','ppor.','nprap.','prap.','pprap.','nstr≈æm.','str≈æm.','rtn.'];

let members = [];

function init(){
    // Naplnƒõn√≠ select≈Ø
    document.getElementById('reg-rank').innerHTML = RANKS.map(r=>`<option value="${r}">${r}</option>`).join('');
    document.getElementById('reg-courses').innerHTML = ALL_COURSES.map(c=>`<label><input type="checkbox" value="${c}"><span>${c}</span></label>`).join('');
    
    // Generov√°n√≠ vozidel
    const vehContainer = document.getElementById('vehicles-container');
    vehContainer.innerHTML = VEHICLES.map((v, vIndex) => `
        <div class="vehicle-card">
            <h3>${v.name}</h3>
            ${v.roles.map((r, rIndex) => {
                const roleId = `role-${vIndex}-${rIndex}`;
                const labelText = r==='any'?'Hasiƒç':r==='OD'?'Operaƒçn√≠ d≈Østojn√≠k':r==='S'?'Strojn√≠k':'Velitel';
                return `
                <div class="form-row">
                    <label>${labelText}:</label>
                    <div class="searchable-wrapper">
                        <input type="text" id="input-${roleId}" class="search-input" placeholder="Hledat..." autocomplete="off" data-role="${r}">
                        <input type="hidden" id="hidden-${roleId}" class="hidden-member-id">
                        <ul id="list-${roleId}" class="suggestions-list"></ul>
                    </div>
                </div>`;
            }).join('')}
        </div>
    `).join('');
    
    attachSearchListeners();
    loadData();
}

// --- NOV√Å LOGIKA PRO VYHLED√ÅV√ÅN√ç ---

function attachSearchListeners(){
    const inputs = document.querySelectorAll('.search-input');
    inputs.forEach(input => {
        const role = input.dataset.role;
        const listId = 'list-' + input.id.replace('input-', '');
        const list = document.getElementById(listId);
        const hiddenInput = document.getElementById('hidden-' + input.id.replace('input-', ''));

        // Focus: Otev≈ô√≠t seznam
        input.addEventListener('focus', () => {
            fillSuggestions(list, role, '');
            list.classList.add('show');
        });

        // Input: Filtrovat
        input.addEventListener('input', (e) => {
            fillSuggestions(list, role, e.target.value.toLowerCase());
            list.classList.add('show');
        });

        // Blur: Zav≈ô√≠t seznam (po mal√© pauze, aby stihl kliknut√≠)
        input.addEventListener('blur', () => {
            setTimeout(() => list.classList.remove('show'), 150);
        });
    });
}

function fillSuggestions(listElement, role, filterText){
    listElement.innerHTML = ''; // Vyƒçist√≠me seznam
    
    // 1. Filtrov√°n√≠
    const filtered = members.filter(m => {
        if(role !== 'any' && (!m.courses || !m.courses.includes(role))) return false;
        const fullText = `${m.rank} ${m.last_name} ${m.first_name}`.toLowerCase();
        return fullText.includes(filterText);
    });

    // 2. Se≈ôazen√≠
    filtered.sort((a,b) => RANKS.indexOf(a.rank) - RANKS.indexOf(b.rank));

    // 3. Generov√°n√≠ polo≈æek BEZPEƒåNƒö (p≈ôes DOM, ne innerHTML string, kv≈Øli apostrof≈Øm ve jm√©nech)
    if(filtered.length === 0){
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.style.cursor = 'default';
        div.style.color = '#888';
        div.textContent = 'Nikdo nenalezen';
        listElement.appendChild(div);
    } else {
        filtered.forEach(m => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            
            // HTML pro obsah (je bezpeƒçn√©, proto≈æe texty jdou z datab√°ze, ale nemus√≠me se b√°t breaknut√≠ JS)
            div.innerHTML = `<span class="rank-badge">${m.rank}</span> ${m.last_name} ${m.first_name}`;
            
            // P≈ôid√°me event listener p≈ô√≠mo na element
            // Pou≈æ√≠v√°me 'mousedown' m√≠sto 'click', proto≈æe se spust√≠ d≈ô√≠ve ne≈æ 'blur' na inputu
            div.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Zabr√°n√≠ ztr√°tƒõ focusu p≈ôed v√Ωbƒõrem (voliteln√©)
                selectMember(m.id, `${m.rank} ${m.last_name}`, listElement.id.replace('list-',''));
            });
            
            listElement.appendChild(div);
        });
    }
}

window.selectMember = function(id, nameText, baseId) {
    const input = document.getElementById('input-' + baseId);
    const hidden = document.getElementById('hidden-' + baseId);
    const list = document.getElementById('list-' + baseId);

    input.value = nameText;
    hidden.value = id;
    list.classList.remove('show');
}

// --- ZBYTEK APLIKACE ---

async function loadData(){
    const { data, error } = await _db.from('members').select('*');
    if(error) return alert("Chyba naƒçten√≠: "+error.message);
    members = data || [];
    renderTable();
}

function renderTable(){
    const tbody = document.querySelector('#members-table tbody');
    const sortedMembers = [...members].sort((a, b) => {
        return RANKS.indexOf(a.rank) - RANKS.indexOf(b.rank);
    });
    tbody.innerHTML = sortedMembers.map(m=>`
        <tr>
            <td>${m.rank}</td>
            <td>${m.first_name} ${m.last_name}</td>
            <td>${(m.courses||[]).map(c=>`<span class="course-tag">${c}</span>`).join('')}</td>
            <td>${m.shift_count||0}</td>
            <td>${m.last_shift || '-'}</td>
            <td>
                <button class="small-btn" onclick="openEdit('${m.id}')">‚úèÔ∏è</button>
                <button class="small-btn" onclick="deleteMember('${m.id}')">‚ùå</button>
            </td>
        </tr>
    `).join('');
}
    
async function registerMember(){
    const fn = document.getElementById('reg-fname').value.trim();
    const ln = document.getElementById('reg-lname').value.trim();
    const crs = Array.from(document.querySelectorAll('#reg-courses input:checked')).map(c=>c.value);
    if(!fn||!ln) return alert("Chyb√≠ jm√©no!");
    const { error } = await _db.from('members').insert({ first_name: fn, last_name: ln, rank: document.getElementById('reg-rank').value, courses: crs, shift_count: 0 });
    if(error) return alert("Chyba: "+error.message);
    alert("ƒålen √∫spƒõ≈°nƒõ registrov√°n!");
    document.getElementById('reg-fname').value='';
    document.getElementById('reg-lname').value='';
    document.querySelectorAll('#reg-courses input').forEach(i=>i.checked=false);
    loadData();
}

async function submitShift(){
    const hiddenInputs = document.querySelectorAll('.hidden-member-id');
    const ids = [...new Set(Array.from(hiddenInputs)
        .map(input => input.value)
        .filter(v => v && /^[0-9a-fA-F\-]{36}$/.test(v))
    )];
    
    if(ids.length === 0) return alert("Nikdo nen√≠ vybr√°n (nebo jsou pole pr√°zdn√°)!");
    
    const date = new Date().toISOString().split('T')[0];
    for(let id of ids){
        const m = members.find(x => String(x.id) === String(id));
        if(m){
            const { error } = await _db.from('members')
                .update({ shift_count: (m.shift_count || 0) + 1, last_shift: date })
                .eq('id', id);
            if(error) console.error("Supabase error:", error);
        }
    }
    alert("Smƒõna zaps√°na!");
    document.querySelectorAll('.search-input').forEach(i => i.value = '');
    document.querySelectorAll('.hidden-member-id').forEach(i => i.value = '');
    loadData();
}

function switchTab(e,id){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    e.currentTarget.classList.add('active');
}

function openEdit(id){
    const m = members.find(x=>String(x.id)===String(id));
    if(!m) return;
    document.getElementById('edit-id').value = m.id;
    document.getElementById('edit-name').innerText = `Upravit ${m.first_name} ${m.last_name}`;
    document.getElementById('edit-count').value = m.shift_count || 0;
    
    const rankSelect = document.getElementById('edit-rank');
    rankSelect.innerHTML = RANKS.map(r=>`<option value="${r}">${r}</option>`).join('');
    rankSelect.value = m.rank;
    
    const div = document.getElementById('edit-courses-div');
    div.innerHTML = ALL_COURSES.map(c=>`<label><input type="checkbox" value="${c}" ${m.courses&&m.courses.includes(c)?'checked':''}><span>${c}</span></label>`).join('');
    
    document.getElementById('edit-modal').style.display='flex';
}

async function saveEdit(){
    const id = document.getElementById('edit-id').value;
    const rank = document.getElementById('edit-rank').value;
    const count = parseInt(document.getElementById('edit-count').value)||0;
    const courses = Array.from(document.querySelectorAll('#edit-courses-div input:checked')).map(i=>i.value);
    const { error } = await _db.from('members').update({ rank, shift_count:count, courses }).eq('id',id);
    if(error) return alert("Chyba: "+error.message);
    closeEdit();
    loadData();
}

async function deleteMember(id){
    if(!confirm("Opravdu chce≈° smazat tohoto ƒçlena?")) return;
    const { error } = await _db.from('members').delete().eq('id', id);
    if(error) return alert("Chyba maz√°n√≠: "+error.message);
    alert("ƒålen byl smaz√°n!");
    loadData();
}

function closeEdit(){document.getElementById('edit-modal').style.display='none';}

document.getElementById('date-display').innerText = new Date().toLocaleDateString('cs-CZ');
init();
</script>
</body>
</html>
